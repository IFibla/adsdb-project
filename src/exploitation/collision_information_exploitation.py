from models.storage.layers.exploitation import Exploitation
import pandas as pd


class CollisionInformationExploitation(Exploitation):
    def _get_trusted_table_names(self) -> list[str]:
        return ["mvc_person", "mvc_vehicles", "nhtsa_safety_rating"]

    def _get_exploitation_table_name(self) -> str:
        return "safety_rating_by_accidents"

    def _join_tables(self) -> pd.DataFrame:
        dfs = {
            table_name: self.trusted_db_connector.get_table_as_dataframe(table_name)
            for table_name in self._get_trusted_table_names()
        }

        return (
            dfs["mvc_person"][
                (~dfs["mvc_person"]["person_type_bicyclist"])
                & (~dfs["mvc_person"]["person_type_other_motorized"])
                & (dfs["mvc_person"]["person_type_occupant"])
                & (~dfs["mvc_person"]["person_type_pedestrian"])
            ][["person_id", "collision_id", "person_age", "person_sex"]]
            .merge(
                dfs["mvc_vehicles"],
                how="left",
                left_on="collision_id",
                right_on="collision_id",
            )[
                [
                    "person_id",
                    "person_age",
                    "person_sex",
                    "vehicle_make",
                    "vehicle_year",
                ]
            ]
            .merge(
                dfs["nhtsa_safety_rating"],
                how="inner",
                left_on=["vehicle_make", "vehicle_year"],
                right_on=["make", "model_year"],
            )[
                [
                    "person_id",
                    "person_age",
                    "person_sex",
                    "vehicle_make",
                    "vehicle_year",
                    "overall_rating",
                ]
            ]
        )
